<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Printer Shares</title>
  <link rel="stylesheet" href="../css/ledger.css">
</head>

<body>
<div class="container">
  <h1>3D Printer Shares</h1>
  <div class="subtitle">
    Vibe-coded cause the other option was to either not create this page entirely or calculate by hand.
  </div>

  <div class="card" id="balances">
    <div class="row">
      <div class="name treasury">Treasury</div>
      <div class="shares" id="treasury">â€“</div>
    </div>
  </div>

  <div class="card">
    <h2 style="font-size:1rem;margin:0 0 .5rem;">Ledger</h2>
    <div id="history"></div>
  </div>
</div>

<script>
const PRECISION = 3;

function roundDisplay(v) {
  return Number(v.toFixed(PRECISION)).toString();
}

function splitAnnotation(line) {
  const match = line.match(/^(.*?)(\s*\[.*\])$/);
  if (!match) return { core: line, note: "" };
  return { core: match[1].trim(), note: match[2] };
}

async function loadLedger() {
  const text = await fetch("ledger.txt").then(r => r.text());
  const historyEl = document.getElementById("history");

  const balances = new Map();
  let treasury = 0;
  let totalMinted = 0;

  for (const raw of text.split("\n")) {
    const line = raw.trim();
    if (!line || line.startsWith("#")) continue;

    const { core, note } = splitAnnotation(line);

    // Render ledger row
    const row = document.createElement("div");
    row.className = "ledger-row";
    row.innerHTML = `
      <div class="ledger-left">${core}</div>
      <div class="ledger-right">${note}</div>
    `;
    historyEl.appendChild(row);

    // Parsing logic
    if (core.startsWith("MINTED")) {
      const amount = parseFloat(core.split(/\s+/)[1]);
      treasury += amount;
      totalMinted += amount;
      continue;
    }

    const match = core.match(
      /^(.+?)\s*->\s*(.+?)\s+(-?\d+(?:\.\d{1,3})?)$/
    );
    if (!match) continue;

    const [, from, to, amountStr] = match;
    const amount = parseFloat(amountStr);

    if (from === "TREASURY") {
      treasury -= amount;
    } else {
      balances.set(from, (balances.get(from) || 0) - amount);
    }

    if (to === "TREASURY") {
      treasury += amount;
    } else {
      balances.set(to, (balances.get(to) || 0) + amount);
    }
  }

  renderBalances(balances, treasury, totalMinted);
}

function renderBalances(balances, treasury, totalMinted) {
  const container = document.getElementById("balances");

  document.getElementById("treasury").textContent =
    roundDisplay(treasury);

  [...balances.entries()]
    .sort((a, b) => b[1] - a[1])
    .forEach(([name, shares]) => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="name">${name}</div>
        <div class="shares">${roundDisplay(shares)}</div>
      `;
      container.appendChild(row);
    });

  const summary = document.createElement("div");
  summary.className = "summary";
  summary.innerHTML = `
    Total minted: ${roundDisplay(totalMinted)}<br>
    In circulation: ${roundDisplay(totalMinted)}
  `;
  container.appendChild(summary);
}

loadLedger();
</script>
</body>
</html>
